{"cells":[{"metadata":{"_uuid":"3dfaf190d505548761b4bb9439719a58ebe601e5","_cell_guid":"421260c1-9811-483f-a785-c8e02e204fda"},"cell_type":"markdown","source":"# Introduction\n\nExploration was made in the previous versions of the kernel and now I have only one goul in mind.\nI will focus in why kNN is so bad in my model and on improve it so i remove some exploratory analysis that I have made in the previous kernels."},{"metadata":{"_uuid":"aca0755c8ec513e071b82b7ac44a8eba53f79957","_cell_guid":"e4acd581-0579-4c7f-a227-1bf9599b3431"},"cell_type":"markdown","source":"# Assign Necessary Libraries"},{"metadata":{"_uuid":"407b6b0442e295de42f653c5b9ef3bebe8e0f8bc","trusted":true,"_cell_guid":"8ea14161-58d4-4b83-8ee4-ca807d2056ec"},"cell_type":"code","source":"# Necessary Libraries \nsuppressMessages(library(gridExtra))\nsuppressMessages(library(grid))\nsuppressMessages(library(ggplot2))\n\nsuppressMessages(library(lattice))\nsuppressMessages(library(caret))\n\n# for validate missing data \nsuppressMessages(library(mice)) \nsuppressMessages(library(VIM))\n\nsuppressMessages(library(dplyr))\nsuppressMessages(library(plyr))\n\nsuppressMessages(library(party))\n\n# h2o modeling kit\nsuppressMessages(library(h2o))","execution_count":1,"outputs":[]},{"metadata":{"_uuid":"dfae87eb3d9853e09763e2618a0f42ed4a883760","_cell_guid":"37e66f04-8a34-4c6e-ada4-246d33c7acdd"},"cell_type":"markdown","source":"# **Loadind the Data**\n"},{"metadata":{"_uuid":"24a12f73d6885ea85b0379c249c39b557727bc21","_cell_guid":"13130543-504e-427c-b2c7-61ec05cf5f27"},"cell_type":"markdown","source":"** Loading the files **"},{"metadata":{"_uuid":"3a3036713571a7fd9baa69ae2998888d52ae50d3","trusted":false,"_cell_guid":"f28eb44b-fd9b-4845-ad49-6ebbace75898"},"cell_type":"code","source":"# load train.csv\nDstTrain <- read.csv('../input/train.csv', stringsAsFactors = FALSE, na.strings = c(\"NA\", \"\"))\n# load test.csv\nDstTest  <- read.csv('../input/test.csv', stringsAsFactors = FALSE, na.strings = c(\"NA\", \"\"))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"ae89a458a54d8001fed78f3875f0d3e31ec3b26b","_cell_guid":"2639440b-72b4-4d2b-8cd7-d9e1881e5073"},"cell_type":"markdown","source":"**Combine all for easy data cleaning**\n\nAll together is easier to clean and explore the data  and insures better missing values prediction."},{"metadata":{"_uuid":"af18e5042605e98b66d46187ce2ab6301512341f","trusted":false,"_cell_guid":"6642eaf6-0b7a-4b4f-b3d4-c12e21e6d3af"},"cell_type":"code","source":"# set survived to NA on the test dataset\nDstTest$Survived <- NA\n\n# set the Set column \nDstTest$Set  <- \"Test\";\nDstTrain$Set <- \"Train\";\n\n# combine all the data\nDstAll <- rbind(DstTrain, DstTest);\n\n# set the TrainSet var\nTrainSet <- DstAll$Set == 'Train'\n\n# set the TestSet var\nTestSet <- DstAll$Set == 'Test'","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"ff3f4d7b3d832561d353e383f735d0e02e718cc5","trusted":false,"_cell_guid":"e0a3a96f-fcaa-430b-952a-5fa53df08ee3"},"cell_type":"code","source":"# Unique values per column\napply(DstAll,2,function(x) length(unique(x)))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"c30db1a1dd2a3918fad8555b45088167c17f198b","_cell_guid":"fde955dd-304b-4182-8839-5b8086e4218a"},"cell_type":"markdown","source":"**Data Info:**\n+ **sex** \n    + gender of the passenger (Male, Female)\n+ **survival**\n    + If survived\t(0 = No, 1 = Yes)\n+ **pclass**\n    + Ticket class\t(1 = 1st, 2 = 2nd, 3 = 3rd)\n+ **embarked**\n    + Port of Embarkation  (C = Cherbourg, Q = Queenstown, S = Southampton)"},{"metadata":{"_uuid":"fca6c32f90714d7e2e8d97c52fafa789f3401adf","_cell_guid":"a6ed0a80-355e-466a-8587-275a795ec252"},"cell_type":"markdown","source":"# Correcting data"},{"metadata":{"_uuid":"31853648d0ac3877cdf434e10ebd69a642099a7d","_cell_guid":"419427f4-b069-42ca-8186-8986b768c79a"},"cell_type":"markdown","source":"**Correcting some data**\n\nThe following fixes SibSp/Parch values for two passengers (Id=280 and Id=1284) according to [**this kernel**](https://www.kaggle.com/c/titanic/discussion/39787) because a 16 year old canâ€™t have a 13 year old son! "},{"metadata":{"_uuid":"76157072336cd5587a96f07711681c20b64719a1","trusted":false,"_cell_guid":"f4c93518-0649-44f0-884a-03bfedb72613"},"cell_type":"code","source":"# Some corrections to the data\nDstAll$SibSp[DstAll$PassengerId==280] <- 0\nDstAll$Parch[DstAll$PassengerId==280] <- 2\nDstAll$SibSp[DstAll$PassengerId==1284] <- 1\nDstAll$Parch[DstAll$PassengerId==1284] <- 1","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"02ea9b292394541d7f71d1f14476413489bfe48c","_cell_guid":"a03921ae-51e9-4912-954b-649de60da827"},"cell_type":"markdown","source":"# Cleaning missing data\n\nLets check the missing data and try to complete it"},{"metadata":{"_uuid":"a89844b830d4d9262f03e1b1232ca93d5858007e","trusted":false,"_cell_guid":"d1e3d22c-d24a-4b34-8f92-6f7d878f48e3"},"cell_type":"code","source":"# The missing data percentage by variable (exclude Survived)\nsapply(DstAll[,-c(2)], function(x) round((sum(is.na(x))/length(x)*100),2))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"13b54a28ac1c734ad9d13d0a18a4fb9f560d7458","_cell_guid":"6bfcb52a-d8df-43ac-844c-b0a6fd263bb6"},"cell_type":"markdown","source":"** Cleaning Embarked column**"},{"metadata":{"_uuid":"3ef8d766a9ce4b0639146a5b6f48896432eb47e1","trusted":false,"_cell_guid":"6dd19eed-3a5d-41ac-9731-b548eec337f5"},"cell_type":"code","source":"# check the frequency of each option\ntable(DstAll$Embarked)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"da1cb19a41006ca04b038be7886989cfd4cf77fd","trusted":false,"_cell_guid":"a792651a-f661-4e5f-90ad-632a34e312d8"},"cell_type":"code","source":"# lets clean it using the most common code to replace\nmissEmb <- is.na(DstAll$Embarked)\n\n# replace the NA \nDstAll[missEmb,]\nDstAll[missEmb,]$Embarked <- 'S'\n\n# show result \nDstAll[missEmb,]","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"5f5ffe2030901c45f8fa0e5416dd90622d507b3b","_cell_guid":"a4927e81-12dc-48c1-9e3c-99683dd6b489"},"cell_type":"markdown","source":"**Cleaning the Age and Fare column**"},{"metadata":{"_uuid":"6d0240f8e14e22d27b9635c7c5e0503c4a4160cd","trusted":false,"_cell_guid":"219453c5-d1f5-4f17-be51-449a59760c79"},"cell_type":"code","source":"# Imputing the missing data\n# The mice() function takes care of the imputing process\nnewData <- mice(DstAll,m=5,maxit=50,meth='pmm',seed=500, printFlag=FALSE)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"8229d837c2be619b657009f0f17c45ae43486511","trusted":false,"_cell_guid":"6a6bd9bd-90fa-4283-9b27-b5cce1b35033"},"cell_type":"code","source":"# the complete clean dataset\nDstAllClean <- complete(newData,1)\n\n# Clear the survived variable\nDstAllClean[DstAllClean$Set == 'Test',]$Survived <- NA\n\n#check for missing\nsapply(DstAllClean[,-c(2)], function(x) round((sum(is.na(x))/length(x)*100),2))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"4fda04b9aacfbd5e6ad2138fec15eb1e8f0bb9ab","trusted":false,"_cell_guid":"c4faad32-381c-4b2a-94bd-2cacbd22f28f"},"cell_type":"code","source":"# set the grid size\npar(mfrow=c(1,2)) # 1x2 grid \npar(pin=c(3,3)) # graph size\n\n# Compute the largest y value used in the Age remove NA\nNoNAAge <- DstAll[!is.na(DstAll$Age),c(\"Age\")]\nhist(NoNAAge, col=heat.colors(10), breaks=10, main=\"Original ages\")\n\n#Clean Ages dataset\nhist(DstAllClean$Age, col=heat.colors(10), breaks=10, main=\"Clean NA ages\")","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"8bd4e2596346fbf9d04e04a33eae8de6a42d4b16","_cell_guid":"af2c80ba-b08d-4745-8f8b-bee6e1956e8c"},"cell_type":"markdown","source":"# Create new variables\n**How about Kids**"},{"metadata":{"_uuid":"abd725593e49f51facb3c7a99661c63713a88947","trusted":false,"_cell_guid":"c37d7c27-7663-4325-a980-4c7787f7fc83"},"cell_type":"code","source":"# the kid factor\nDstAllClean$Kid[DstAllClean$Age <= 18] <- \"Yes\"\nDstAllClean$Kid[DstAllClean$Age > 18] <- \"No\"","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"3682f1ed90536d3cd3009fcb9dc24f6852389bc1","_cell_guid":"31be3a68-beb5-4659-b8a1-247b9ee37e6a"},"cell_type":"markdown","source":"**The Titles are Important**\n\nTake care of people titles and check how important they are for survive"},{"metadata":{"_uuid":"ee76c971ea3feab3a9a82cc9d18d5b4659ab2f9c","trusted":false,"_cell_guid":"dee37427-f951-42ab-b350-59dc8dfdf862"},"cell_type":"code","source":"# get the title from name\nDstAllClean$Title <- gsub('(.*, )|(\\\\..*)', '', DstAllClean$Name)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"202032e70c9be9e32bb7a9833bffa1e2848c91ee","trusted":false,"_cell_guid":"8602efcd-cbef-4147-a702-a7ed37314acb"},"cell_type":"code","source":"# Titles by Sex\ntable(DstAllClean$Sex, DstAllClean$Title)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"e465d76c76361629fd01cf68169f759ec7c102fd","trusted":false,"_cell_guid":"70101250-4662-4e02-9986-65f0edd9c21f"},"cell_type":"code","source":"other <- c('Capt', 'Col', 'Don', 'Dr', 'Major', 'Rev')\nroyalty <- c('Dona', 'Lady', 'the Countess','Sir', 'Jonkheer')\n\nDstAllClean$Title[DstAllClean$Title == 'Mlle']        <- 'Miss' \nDstAllClean$Title[DstAllClean$Title == 'Ms']          <- 'Miss'\nDstAllClean$Title[DstAllClean$Title == 'Mme']         <- 'Mrs' \nDstAllClean$Title[DstAllClean$Title %in% royalty]  <- 'Royalty'\nDstAllClean$Title[DstAllClean$Title %in% other]  <- 'Officer'","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"12a8fdc238dc07617b9060726406f37909d8127b","_cell_guid":"c55e3096-36fe-4fed-b5ea-25c61019a67b"},"cell_type":"markdown","source":"**Family size**"},{"metadata":{"_uuid":"d3209859d9bddd5a3d10bedcd28506c1ffc33d38","trusted":false,"_cell_guid":"e4bfb9ca-af59-43e3-86f0-2cae8f063ea2"},"cell_type":"code","source":"# Family size\nDstAllClean$FamilySize <- DstAllClean$SibSp + DstAllClean$Parch + 1\n\n# Group the sizes\nDstAllClean$FamilyType[DstAllClean$FamilySize == 1] <- 'Alone'\nDstAllClean$FamilyType[DstAllClean$FamilySize <= 3 & DstAllClean$FamilySize > 1] <- 'Small'\nDstAllClean$FamilyType[DstAllClean$FamilySize > 3] <- 'Big'","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"6c419d47af7dc042aad6a0fc54b005a7d290200a","_cell_guid":"0074d7f8-a308-4062-b597-dc6a9a3b600a"},"cell_type":"markdown","source":"**Fare by person**"},{"metadata":{"_uuid":"10db4800791b5422a2a64cc78a31ab5f74c4ed87","trusted":false,"_cell_guid":"6132d7e3-1504-4b0c-a4a7-000c3b8c54cc"},"cell_type":"code","source":"# lets find the fare by person\nDstAllClean$FareByP <- DstAllClean$Fare / DstAllClean$FamilySize","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"2247402a250e0161d80a1e9c741eb0e258637453","_cell_guid":"7d20c101-907b-41b5-8cd9-cab9a04f754e"},"cell_type":"markdown","source":"**Family together**"},{"metadata":{"_uuid":"4723c6d73afd8ba89f9ceff233ac4a0a925c46be","trusted":false,"_cell_guid":"5eb04a02-ae41-4af1-bbc1-b9e2cc06eaa7"},"cell_type":"code","source":"# Lets try to get the family together\nDstAllClean$Surname <- sapply(DstAllClean$Name, FUN=function(x) {strsplit(x, split='[,.]')[[1]][1]})\nDstAllClean$FamilyID <- paste(as.character(DstAllClean$Family_size), DstAllClean$Surname, sep=\"\")\n\n# less than 2 so is alone for sure\nDstAllClean$FamilyID[DstAllClean$FamilySize < 2] <- 'Alone'\n\n# by frequency\nfamIDs <- data.frame(table(DstAllClean$FamilyID))\nfamIDs <- famIDs[famIDs$Freq < 2,]\n\n# some are also alone\nDstAllClean$FamilyID[DstAllClean$FamilyID %in% famIDs$Var1] <- 'Alone'","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"2146fc4601b63eabc8f23bb32b9b64222e998c63","_cell_guid":"137a2d10-79bb-4118-86d7-4337ba73e9f4"},"cell_type":"markdown","source":"**Have kids so is mother**"},{"metadata":{"_uuid":"0d772926d0ebb8d6facad27140e1098d9a4ee9c6","trusted":false,"_cell_guid":"a9801dc5-1fa5-4cd7-be1c-11ade9436aa2"},"cell_type":"code","source":"# default is No \nDstAllClean$IsMother <- 'No'\nDstAllClean$IsMother[DstAllClean$Sex == 'female' & DstAllClean$Parch > 0 & DstAllClean$Age > 18 & DstAllClean$Title != 'Miss'] <- 'Yes'","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"a9c9213e23d86c9c829d96254b4cc4a6ded05c70","trusted":false,"_cell_guid":"ec4d4780-234c-4647-a693-9446f8f50dfc"},"cell_type":"code","source":"# create the goupping function with the define intervals\nCreateGrp <- function(val){\n    if (val >= 0 & val <= 20){\n        return('0-20')\n    }else if(val > 20 & val <= 30){\n        return('20-30')\n    }else if (val > 30 & val <= 40){\n        return('30-40')\n    }else if (val > 40 & val <=50){\n        return('40-50')\n    }else if (val > 50 & val <=60){\n        return('50-60')\n    }else if (val > 60){\n        return('> 60')\n    }\n}\n# apply the Group function to the age column\nDstAllClean$AgeGrp <- sapply(DstAllClean$Age,CreateGrp)\n# check the frequency for each group bin\ntable(DstAllClean$AgeGrp)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"57cbe9d19b00ad0aa73b160688170f7de52a6d72","_cell_guid":"af570dc9-58e9-454f-ac75-bfeff8b0f3ef"},"cell_type":"markdown","source":"## Explore some of the variables\n\nI know we have explored it in the previous kernels but I have introduced a couple of new variables and I want to analyze them for some details.\n![](data:image/png;base64,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)"},{"metadata":{"_uuid":"b580b028eb7786f1a78939e178d12b83595156c9","trusted":false,"_cell_guid":"cd3b37b9-d89f-40ce-8bcc-d7c7789e0d06"},"cell_type":"code","source":"# my plots will be very similar lets simplify using a function for it\ncreateplot <- function(dst, column, name) {\n    plt <- ggplot(dst, aes(x=column, fill = factor(Survived))) + \n        ggtitle(name) + \n        xlab(name) +\n        ylab(\"Percentage\")  +\n        geom_bar(aes(y = 100*(..count..)/sum(..count..)), width = 0.7) + \n        theme_minimal() +\n        theme(legend.position=\"none\", axis.text.x = element_text(angle = 45, hjust = 1)) +\n        scale_fill_manual(values=c(\"#B22222\",\"#D0D0D0\"))\n    return(plt)\n}","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"db6986d1e7acafd5a46f5b2940b2542646b44c6a","trusted":false,"_cell_guid":"2d856024-ee28-456b-b52a-be1e1afb5940"},"cell_type":"code","source":"dstPlot <- DstAllClean[TrainSet,]\n\n# Plot 1\np1 <- createplot(dstPlot, dstPlot$Title, \"Title\")                      \n# plot 2\np2 <- createplot(dstPlot, dstPlot$Kid, \"Kid\")\n# plot 3\np3 <- createplot(dstPlot, dstPlot$IsMother, \"Is Mother\")\n# plot 4\np4 <- createplot(dstPlot, dstPlot$FamilyType, \"Family Type\")\n# plot 5\np5 <- createplot(dstPlot, dstPlot$Sex, \"Sex\")\n# plot 6\np6 <- createplot(dstPlot, dstPlot$Pclass, \"Class\")\n\n# draw the plot grid\ngrid.arrange(p1, p2, p3, p4, p5, p6, ncol=3)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"d35189941c49e2bac5f9a75144265dd3165504ce","trusted":false,"_cell_guid":"de4ec005-bc87-406b-8a92-9479322d3541"},"cell_type":"code","source":"createplot(dstPlot, dstPlot$AgeGrp, \"Group of Ages\")     ","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"71de50750ef3823b042e2de51d85438d3b0ed164","_cell_guid":"e8d18a0f-bb0d-49f3-896e-18b04378c83f"},"cell_type":"markdown","source":"# Modeling\n**Start H2O**\n\nStart up a 1-node H2O server on your local machine, and allow it to use all CPU cores and up to 2GB of memory:\n\n"},{"metadata":{"_uuid":"7309c5aeeec7d60c271c860392afb50f04de1eeb","trusted":false,"_cell_guid":"c38fcde7-27a1-472c-a0c8-324a51da2081"},"cell_type":"code","source":"h2o.init(nthreads=-1, max_mem_size=\"6G\")\nh2o.removeAll()    # clean slate - just in case the cluster was already running\nh2o.no_progress()  # Don't show progress bars in RMarkdown output","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"0283ef83baf784ac936ea92c1cb5a4881076a45b","_cell_guid":"faeab242-2d34-4455-a35b-e49a34dd1082"},"cell_type":"raw","source":""},{"metadata":{"_uuid":"7a80afaa319379f5ab97a6f72684f6af3e19d96f","trusted":false,"_cell_guid":"8d2aa9f7-e751-4f55-9229-3b2367f0b00d"},"cell_type":"code","source":"sapply(DstAllClean[,-c(2)], function(x) round((sum(is.na(x))/length(x)*100),2))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"c07d87dc6a56eb49bf5f90c873c4fd3f240122f1","trusted":false,"_cell_guid":"06377206-f989-4592-b82a-55896b95abc3"},"cell_type":"code","source":"keepVars <- c(\"Survived\",\"Pclass\",\"Sex\",\"Parch\",\"Fare\",\"Title\",\"FamilySize\",\"FamilyType\",\"FareByP\",\"FamilyID\",\"Kid\")\n# vars to drop\nToKeep <- which(names(DstAllClean) %in% keepVars)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"ca675315dda693f8c37de361df246aeed532fcb7","trusted":false,"_cell_guid":"e3e461d6-7a81-4ca7-bb4e-40e13f564654"},"cell_type":"code","source":"# convert all factor or character columns to numeric\ntoNumeric <- function(dst) {\n    cols <- colnames(dst)\n    for (c in cols) {\n      if ((class(dst[[c]])==\"factor\") || (class(dst[[c]])==\"character\")) {\n        levels <- unique(dst[[c]])\n        dst[[c]] <- as.numeric(factor(dst[[c]], levels=levels))\n      }\n    }\n    toNumeric <- dst\n}","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"f8c83009cbae7406f046f6c9f6fcc75e6fe413bf","trusted":false,"_cell_guid":"a15b816f-854c-4f23-b612-be4f01bba110"},"cell_type":"code","source":"DstTrainTest <- toNumeric(DstAllClean[TrainSet,ToKeep])","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"c825c61e2cf0f2a87e19fb5997e49e74eedb85b6","trusted":false,"_cell_guid":"76a427e0-1365-45a5-b12d-a14ce12e343b"},"cell_type":"code","source":"head(DstTrainTest)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"a3c82da3dd22f85dc6eec107f6b38dd6b11dcb24","trusted":false,"_cell_guid":"af2204a5-0148-4a01-9b88-d1566472a40d"},"cell_type":"code","source":"# For binary classification, response should be a factor\nDstTrainTest$Survived <- as.factor(DstTrainTest$Survived)\nlevels(DstTrainTest$Survived) = make.names(unique(DstTrainTest$Survived))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"a55c00d91ceffe74a23ab47cf97ca0ed3b5d697c","trusted":false,"_cell_guid":"d1075de6-8d70-4291-91e0-06ba27f7e589"},"cell_type":"code","source":"# convert to h2o frame \nh2o_TrainAux = as.h2o(DstTrainTest)\n\n# define the splits\nh2o_splits <- h2o.splitFrame(h2o_TrainAux, 0.75, seed=1234)\nh2o_DstTrain  <- h2o.assign(h2o_splits[[1]], \"train.hex\") # 75%\nh2o_DstTest  <- h2o.assign(h2o_splits[[2]], \"test.hex\") # 25%","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"08b67527afd65e51cbcdb1b9b7d4cbdb14003a20","trusted":false,"_cell_guid":"5f10ad45-40f0-4404-8b08-157822d803e6"},"cell_type":"code","source":"# Identify predictors and response\nresponse <- \"Survived\"\npredictors <- setdiff(names(h2o_DstTrain), response)\n\n# Number of CV folds (to generate level-one data for stacking)\ncvfolds <- 5","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"69344aa0ef0fb7415bb559fcd5e7852e69fdbb1d","_cell_guid":"24bb7e4b-a7b0-438b-8a5d-b7c673fbd89f"},"cell_type":"markdown","source":"**H2O base models**"},{"metadata":{"_uuid":"5b37d8158085f02949e8eab90ed11d377c3b71d1","trusted":false,"_cell_guid":"3d5d4981-555b-4917-8047-7966ef29c620"},"cell_type":"code","source":"# Train & Cross-validate a GBM\nmy_gbm <- h2o.gbm(x = predictors,\n                  y = response,\n                  training_frame = h2o_DstTrain,\n                  distribution = \"bernoulli\",\n                  max_depth = 3,\n                  min_rows = 2,\n                  learn_rate = 0.2,\n                  nfolds = cvfolds,\n                  fold_assignment = \"Modulo\",\n                  keep_cross_validation_predictions = TRUE,\n                  seed = 1)\n\n# Train & Cross-validate a RF\nmy_rf <- h2o.randomForest(x = predictors,\n                          y = response,\n                          training_frame = h2o_DstTrain,\n                          nfolds = cvfolds,\n                          fold_assignment = \"Modulo\",\n                          keep_cross_validation_predictions = TRUE,\n                          seed = 1)\n\n# Train & Cross-validate a DNN\nmy_dl <- h2o.deeplearning(x = predictors,\n                          y = response,\n                          training_frame = h2o_DstTrain,\n                          l1 = 0.001,\n                          l2 = 0.001,\n                          hidden = c(200, 200, 200),\n                          nfolds = cvfolds,\n                          fold_assignment = \"Modulo\",\n                          keep_cross_validation_predictions = TRUE,\n                          seed = 1)\n","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"97b4f72131e43f0efb91e7216559296fce19e2dd","_cell_guid":"c71fb3cb-b6c5-4fc3-9cd8-2d7d99520169"},"cell_type":"markdown","source":"**XGBoost base models**"},{"metadata":{"_uuid":"8f02968347a848a9e2e5535690d8590aa8e01404","trusted":false,"_cell_guid":"5b858647-604b-49a0-a75b-afcc7ca0ce8f"},"cell_type":"code","source":"# Train & Cross-validate a (shallow) XGB-GBM\nmy_xgb1 <- h2o.xgboost(x = predictors,\n                       y = response,\n                       training_frame = h2o_DstTrain,\n                       distribution = \"bernoulli\",\n                       ntrees = 50,\n                       max_depth = 3,\n                       min_rows = 2,\n                       learn_rate = 0.2,\n                       nfolds = cvfolds,\n                       fold_assignment = \"Modulo\",\n                       keep_cross_validation_predictions = TRUE,\n                       seed = 1)\n\n\n# Train & Cross-validate another (deeper) XGB-GBM\nmy_xgb2 <- h2o.xgboost(x = predictors,\n                       y = response,\n                       training_frame = h2o_DstTrain,\n                       distribution = \"bernoulli\",\n                       ntrees = 50,\n                       max_depth = 8,\n                       min_rows = 1,\n                       learn_rate = 0.1,\n                       sample_rate = 0.7,\n                       col_sample_rate = 0.9,\n                       nfolds = cvfolds,\n                       fold_assignment = \"Modulo\",\n                       keep_cross_validation_predictions = TRUE,\n                       seed = 1)\n","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"4686ec9ffe33ad39c91539f34f83d4f919cc4043","_cell_guid":"c60b4347-6b3c-411b-b69e-5e38609f8208"},"cell_type":"markdown","source":"**Create a Stacked Ensemble**\n\nTo maximize predictive power, will create an H2O Stacked Ensemble from the models we created above and print the performance gain the ensemble has over the best base model."},{"metadata":{"_uuid":"ec3c15e5e20542d5fcc8acb10edb88497130b6b4","trusted":false,"_cell_guid":"b2acd492-b635-4e29-86d2-db87c9c2acc0"},"cell_type":"code","source":"# Train a stacked ensemble using the H2O and XGBoost models from above\nbase_models <- list(my_gbm@model_id, my_rf@model_id, my_dl@model_id,  \n                    my_xgb1@model_id, my_xgb2@model_id)\n\nensemble <- h2o.stackedEnsemble(x = predictors,\n                                y = response,\n                                training_frame = h2o_DstTrain,\n                                base_models = base_models)\n\n# Eval ensemble performance on a test set\nperf <- h2o.performance(ensemble, newdata = h2o_DstTest)\n\n\n# Compare to base learner performance on the test set\nget_auc <- function(mm) h2o.auc(h2o.performance(h2o.getModel(mm), newdata = h2o_DstTest))\nbaselearner_aucs <- sapply(base_models, get_auc)\nbaselearner_best_auc_test <- max(baselearner_aucs)\nensemble_auc_test <- h2o.auc(perf)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"ec3f735f846a7728a0b2de4b7845f9229577c76c","_cell_guid":"48c14325-0e43-4f67-9401-a56fbd6cef39"},"cell_type":"markdown","source":"Compare the test set performance of the best base model to the ensemble."},{"metadata":{"_uuid":"27d8257d963da8d4abaecab603ae3b72ecab9574","trusted":false,"_cell_guid":"159341bb-cdb1-402b-8345-e87904d49372"},"cell_type":"code","source":"print(sprintf(\"Best Base-learner Test AUC:  %s\", baselearner_best_auc_test))\nprint(sprintf(\"Ensemble Test AUC:  %s\", ensemble_auc_test))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"10c5198ebea61ad6ad7866cdd8e5e39b2855a65e","_cell_guid":"e427105a-c51f-4cd5-80ea-31ceb23a1350"},"cell_type":"markdown","source":"**Final submition**"},{"metadata":{"_uuid":"4aebb84e904abbb132cd2dbd6410d83d59c34749","trusted":false,"_cell_guid":"07f6887d-cc43-4d57-82e3-2d98c90cbe84"},"cell_type":"code","source":"# convert to h2o frame \n#h2o_FinalTest = as.h2o(DstTest[,ToDropTest])\nh2o_FinalTest = as.h2o(toNumeric(DstAllClean[TestSet,ToKeep]))\n\n# predict with the model\npredictFinal <- h2o.predict(ensemble, h2o_FinalTest)\n\n# convert H2O format into data frame and save as csv\npredictFinal.df <- as.data.frame(predictFinal)","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"8fa11fad67bc473c7847b49e8ac1dec86ba908de","trusted":false,"_cell_guid":"ef6b242b-63c8-4074-bc5d-86ed18686853"},"cell_type":"code","source":"predictFinal.df$Survived <- as.factor(mapvalues(predictFinal.df$predict,c(\"X0\", \"X1\"),c(0,1)))","execution_count":null,"outputs":[]},{"metadata":{"_uuid":"def96ccfa96c9e209fe94126429b4e667ad320d8","trusted":false,"_cell_guid":"62dab764-fd0e-469a-9442-72a3ede36644"},"cell_type":"code","source":"# create a csv file for submittion\nTitanicResult <- data.frame(PassengerId = DstAllClean[TestSet,]$PassengerId, Survived = predictFinal.df$Survived)\nhead(TitanicResult,n=5L)\n# write the submition file\nwrite.csv(TitanicResult,file = \"Result.csv\",row.names = FALSE)\ntable(TitanicResult$Survived)","execution_count":null,"outputs":[]}],"metadata":{"kernelspec":{"display_name":"R","language":"R","name":"ir"},"language_info":{"mimetype":"text/x-r-source","name":"R","pygments_lexer":"r","version":"3.4.2","file_extension":".r","codemirror_mode":"r"}},"nbformat":4,"nbformat_minor":1}