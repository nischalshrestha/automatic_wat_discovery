{"cells": [{"execution_count": null, "outputs": [], "source": "# Predicting the survival rate of the Titanic disaster\nScore on Public Leaderboard: 0.81340\n\n## Step 1 - collecting data", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "4188f71a-a654-4a75-a9a5-61c513747fc1", "collapsed": false, "_uuid": "7b2814e735d5ab6d50169acbd166adaf878128e7"}}, {"execution_count": null, "outputs": [], "source": "suppressMessages(library('ggplot2')) # visualization\nsuppressMessages(library('ggthemes')) # visualization\nsuppressMessages(library('scales')) # visualization\nsuppressMessages(library('dplyr')) # data manipulation\nsuppressMessages(library('mice')) # imputation\nsuppressMessages(library('randomForest')) # classification algorithm", "cell_type": "code", "metadata": {"_execution_state": "idle", "trusted": false, "_cell_guid": "adf2031c-4170-4a44-b0ce-ae7d53cdbadf", "_uuid": "b8b19e261e8798a0c2940e621a32fd46c5b0ec13"}}, {"execution_count": null, "outputs": [], "source": "train <- read.csv('../input/train.csv', stringsAsFactors = F)\ntest  <- read.csv('../input/test.csv', stringsAsFactors = F)\n\nfull  <- bind_rows(train, test)", "cell_type": "code", "metadata": {"_cell_guid": "fb670f7d-5c96-42f4-b7bd-9aa5c61a357b", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "b4ed2adcdd1ba6a4ba630cc98f15b0a80bb52854"}}, {"execution_count": null, "outputs": [], "source": "## Step 2 - exploring and preparing the data", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "a6800aed-4095-4268-ae46-d5496a4a2977", "collapsed": false, "_uuid": "dccf305aec8c3d6e647b5389837ae5014f8b47ed"}}, {"execution_count": null, "outputs": [], "source": "# check data\nstr(full)", "cell_type": "code", "metadata": {"_cell_guid": "d96b5c0f-dfe6-4c83-ba02-9e25ab6d3b43", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "02df414d1d8512dc63ab0b1ce023f64ae001b893"}}, {"execution_count": null, "outputs": [], "source": "### Looking for missing data", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "ca5c691e-eee7-4c5e-a618-151bf62aaf19", "collapsed": false, "_uuid": "e9a92961395257512a9359e66130ab5a68eb8a2a"}}, {"execution_count": null, "outputs": [], "source": "full[full==''] <- NA\nsapply(full, function(x) sum(is.na(x)))", "cell_type": "code", "metadata": {"_cell_guid": "c53187e6-d678-4c11-8ea2-7e13ef5f2d46", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "77cbfc747dfd6035bac42f05e64ac4a84c8ee84c"}}, {"execution_count": null, "outputs": [], "source": "### Passenager Names", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "8dc325b4-1e66-4847-bed1-6f56afbe7150", "collapsed": false, "_uuid": "3796947aa5372bec074943c89e2108da74672418"}}, {"execution_count": null, "outputs": [], "source": "# Grab title from passenger names\nfull$Title <- gsub('.*, ([^.]*)\\\\..*', '\\\\1', full$Name)\n\n# Title vs Survivor\ntable(full$Title, full$Survived)", "cell_type": "code", "metadata": {"_cell_guid": "9f9c1b81-46b5-43d5-8768-a4bbba60e172", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "0c7a71ba2dd308b66b15b7bf14ac4182f999629b"}}, {"execution_count": null, "outputs": [], "source": "# Replace rare titles\nfull$Title[full$Title == 'Mlle'] <- 'Miss'\nfull$Title[full$Title == 'Ms'] <- 'Miss'\nfull$Title[full$Title == 'Mme'] <- 'Mrs'\n# Group rare Title to officer and royalty\nofficer <- c('Capt', 'Col', 'Don', 'Dr', 'Major', 'Rev')\nroyalty <- c('Dona', 'Lady', 'the Countess','Sir', 'Jonkheer')\nfull$Title[full$Title %in% officer] <- 'officer'\nfull$Title[full$Title %in% royalty] <- 'royalty'\n\n# Show title counts by sex\ntable(full$Sex, full$Title)", "cell_type": "code", "metadata": {"_cell_guid": "c8f52c79-18fd-455e-ac9f-c897560838d6", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "18399c0bf26a25e372c12857cc983c5d57e3c001"}}, {"execution_count": null, "outputs": [], "source": "# Get Surnames\nfull$Surname <- gsub('([^,]*),.*', '\\\\1', full$Name)\nstr(factor(full$Surname))", "cell_type": "code", "metadata": {"_cell_guid": "8e58354f-7fc3-4cf3-97a2-ccbbeac36a2d", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "47a9a2124f08ce405e317ffb8e596dadc3ed6a3e"}}, {"execution_count": null, "outputs": [], "source": "### Cabins and Decks\nThere are 1014 out of 1309 cabins missing. Let's reduce the cabin to the deck it is on (1st letter).", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "7ed9eafe-bb8f-4158-8d62-3b49453ffbf3", "collapsed": false, "_uuid": "8a10c58f516aad240b3968537f736750981ccbef"}}, {"execution_count": null, "outputs": [], "source": "full$Deck <- sapply(as.character(full$Cabin), function(x) strsplit(x, NULL)[[1]][1])\n# Replace NA with 'U' (Unknown)\nfull <- within(full,\n   Deck <- ifelse(is.na(Deck),'U',Deck)\n)\n# Group upper, middle and lower decks\nfull$Deck[full$Deck == 'A' | full$Deck == 'B'] <- 'upper_deck'\nfull$Deck[full$Deck == 'C' | full$Deck == 'D'] <- 'middle_deck'\nfull$Deck[full$Deck == 'E' | full$Deck == 'F' | \n          full$Deck == 'G' | full$Deck == 'T'] <- 'lower_deck'\n    \nfull$Deck <- factor(full$Deck)\n    \nprint(summary(full$Deck))", "cell_type": "code", "metadata": {"_cell_guid": "e241cc57-8fe2-4b7f-8c88-51a933a50fe8", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "b699b7b5a865cde3d086c846de63059fa09b8600"}}, {"execution_count": null, "outputs": [], "source": "### Family structure", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "fce35981-98b2-446f-9ae9-7602ce1f7b4f", "collapsed": false, "_uuid": "bddd1d6a41f754b1f81aee18f8abafa58f853c56"}}, {"execution_count": null, "outputs": [], "source": "# Familie size: siblings + spouses + parents + children + Passenger themselve\nfull$Fsize <- full$SibSp + full$Parch + 1\n\n# Group also people in the same cabin with family size == 1\ncabins <- full$Cabin\nn_occur <- data.frame(table(Var1=cabins))\nn_occur <- subset(n_occur, nchar(as.character(Var1)) > 1)\n\nsharedCabins <- n_occur$Var1[n_occur$Freq > 1]\n\nsharedInd <- full$Fsize == 1 & full$Cabin %in% sharedCabins\nfull$Fsize[sharedInd] <- 2", "cell_type": "code", "metadata": {"_cell_guid": "3daa5435-8a77-459f-860d-d4b80e279540", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "fdc23dc8ecff900cb6bb1bf7c36c828aeb18728a"}}, {"execution_count": null, "outputs": [], "source": "# Concatenate surname w/ family size\nfull$Family <- paste(full$Surname, full$FsizeAdj, sep='_')\n\n# Plot Family Size vs Survivor\nggplot(full[1:891, ], aes(x = Fsize, fill = factor(Survived))) +\n  geom_bar(stat='count', position='dodge') +\n  scale_x_continuous(breaks=c(1:11)) +\n  labs(x = 'Family Size') +\n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "9204c7c8-c4c6-4ce8-b9a1-0b1211574bfb", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "71bee2b2e1d1d57a8e2ff6984b5648f5fa2c9522"}}, {"execution_count": null, "outputs": [], "source": "# Discretize family size\nfull$FsizeD[full$Fsize == 1] <- 'singleton'\nfull$FsizeD[full$Fsize < 5 & full$Fsize > 1] <- 'small'\nfull$FsizeD[full$Fsize > 4] <- 'large'\n\n# Show family size by survival using a mosaic plot\nmosaicplot(table(full$FsizeD, full$Survived), main='Family Size by Survival', shade=TRUE)", "cell_type": "code", "metadata": {"_cell_guid": "c5e4921a-6265-4038-bdc3-212a0cddff76", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "732555707e23a06fd24f2ac27b0cba8cbbb5c94a"}}, {"execution_count": null, "outputs": [], "source": "### Port of Embarkation and Passenger Fare\nC = Cherbourg, Q = Queenstown, S = Southampton", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "70b18dbe-604e-40c0-8a35-af26f6b6f6ea", "collapsed": false, "_uuid": "7a03ada6e09dd671c23424f2e1ceed381789df7d"}}, {"execution_count": null, "outputs": [], "source": "# There are missing values\nstr(factor(full$Embarked))\nfull$PassengerId[full$Embarked == '']\nfull$Pclass[full$Embarked == '']\n\nggplot(full, aes(x = Embarked, y = Fare, fill = factor(Pclass))) +\n  geom_boxplot() +\n  geom_hline(aes(yintercept=80), \n    colour='red', linetype='dashed', lwd=2) +\n  scale_y_continuous(labels=dollar_format()) +\n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "717f1e03-db0e-4cb4-8b50-927893636c15", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "0730fc10ecd1618724e4dd02fb6f5d363b05da48"}}, {"execution_count": null, "outputs": [], "source": "# Missing values are both class 1; safe to say they embark in Cherbourg\nfull$Embarked[c(62, 830)] <- 'C'", "cell_type": "code", "metadata": {"_cell_guid": "2bb255bb-d801-4cde-82d2-44c723450e07", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "c45cf711b53eb211689e364db71264d71afd9a0a"}}, {"execution_count": null, "outputs": [], "source": "# There are missing values\nstr(factor(full$Fare))\nfull$PassengerId[is.na(full$Fare) == TRUE]\n\nggplot(full[full$Pclass == '3' & full$Embarked == 'S', ], \n  aes(x = Fare)) +\n  geom_density(fill = '#99d6ff', alpha=0.4) + \n  geom_vline(aes(xintercept=median(Fare, na.rm=T)),\n    colour='red', linetype='dashed', lwd=1) +\n  scale_x_continuous(labels=dollar_format()) +\n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "df411dbb-6683-4484-806e-5f43ac45664d", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "b0f0da7ccdb6cb21c8d97c91123e9cab628447ee"}}, {"execution_count": null, "outputs": [], "source": "# Replace missing fare value with median fare for class/embarkment\nfull$Fare[1044] <- median(full[full$Pclass == '3' & full$Embarked == 'S', ]$Fare, na.rm = TRUE)", "cell_type": "code", "metadata": {"_cell_guid": "e0892489-f0b6-4ccc-a18d-f2fb00f382d9", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "3d821f1091ed508282b7d4d9c4b44b252da7d0e1"}}, {"execution_count": null, "outputs": [], "source": "### Age", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "4efb7f09-6f5f-4f72-849b-efd3a3c5ee06", "collapsed": false, "_uuid": "942261f58b5d0ea37f3397539fec3adf92af96d3"}}, {"execution_count": null, "outputs": [], "source": "# First we'll look at the relationship between age, title & survival\nggplot(full[1:891,], aes(Age, fill = factor(Survived))) + \n  geom_histogram() + \n  # I include Sex since we know (a priori) it's a significant predictor\n  facet_grid(.~Title) + \n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "d84c52ea-9207-4064-9901-1971e14e71c4", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "0ecd47994686490a80a61e0a7c75473c4624382e"}}, {"execution_count": null, "outputs": [], "source": "# Show number of missing Age values\nsum(is.na(full$Age))\n\n# We know 'Masters' are young boys\nsum(is.na(full$Age[full$Title == 'Master']))\nsummary(full$Age[full$Title == 'Master'])\nfull$Age[is.na(full$Age) & full$Title == 'Master'] <- 4", "cell_type": "code", "metadata": {"_cell_guid": "9449d222-cf88-45d5-b683-c039b1f42486", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "26b3e29c8394645d1b4d80d0e9ee11ccb2629b67"}}, {"execution_count": null, "outputs": [], "source": "# Make variables factors into factors\nfactor_vars <- c('PassengerId', 'Pclass','Sex','Embarked', 'Deck',\n                 'Title','Surname','Family','FsizeD')\n\nfull[factor_vars] <- lapply(full[factor_vars], function(x) as.factor(x))\n\n# Set a random seed\nset.seed(129)\n\n# Perform mice imputation, excluding certain less-than-useful variables:\n#mice_mod <- mice(full[, !names(full) %in% c('Name','Ticket','Family','Surname','Survived')], method='rf') \nmice_mod <- mice(full[, !names(full) %in% c('PassengerId','Name','Ticket','Cabin','Family','Surname','Survived', 'Deck')], method='rf') \n    \n# Save the complete output \nmice_output <- complete(mice_mod)", "cell_type": "code", "metadata": {"_cell_guid": "1ebda279-8b43-41c7-b535-352797b93c37", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "5dda397cd5adcece5300fa6055f33d7cf6b64efd"}}, {"execution_count": null, "outputs": [], "source": "# Plot age distributions\npar(mfrow=c(1,2))\nhist(full$Age, freq=F, main='Age: Original Data', \n  col='darkgreen', ylim=c(0,0.04))\nhist(mice_output$Age, freq=F, main='Age: MICE Output', \n  col='lightgreen', ylim=c(0,0.04))", "cell_type": "code", "metadata": {"_cell_guid": "373a630e-ffd4-4b6c-956f-4de2f76bc5ac", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "db041a5c21b5e4d0c7840bf948dba740e0ed61ff"}}, {"execution_count": null, "outputs": [], "source": "# Replace Age variable from the mice model.\nfull$Age <- mice_output$Age\n\n# Show new number of missing Age values\nsum(is.na(full$Age))", "cell_type": "code", "metadata": {"_cell_guid": "e13f73af-4044-418a-b8a1-a266603e2f8e", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "4d51a98693f9155d2283799228790c28ccc4ff5f"}}, {"execution_count": null, "outputs": [], "source": "# First we'll look at the relationship between age & survival\nggplot(full[1:891,], aes(Age, fill = factor(Survived))) + \n  geom_histogram() + \n  # I include Sex since we know (a priori) it's a significant predictor\n  facet_grid(.~Title) + \n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "53b74583-3cb3-40be-93fe-a265bdaa95a0", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "5741eb3a484f62bfbe3f8f8530638df341fbb6ee"}}, {"execution_count": null, "outputs": [], "source": "# First we'll look at the relationship between age & survival\nggplot(full[1:891,], aes(Age, fill = factor(Survived))) + \n  geom_histogram() + \n  # I include Sex since we know (a priori) it's a significant predictor\n  facet_grid(.~Sex) + \n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "b68d4831-63bc-4f44-9486-d160a14c72fc", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "38f4187a0e36d2efc65b11eeebc875e0f3d0b31e"}}, {"execution_count": null, "outputs": [], "source": "# Create the column child, and indicate whether child or adult\nfull$Child[full$Age < 18] <- 'Child'\nfull$Child[full$Age >= 18] <- 'Adult'\n\n# Show counts\ntable(full$Child, full$Survived)\n\n# Adding Mother variable\nfull$Mother <- 'Not Mother'\nfull$Mother[full$Sex == 'female' & full$Parch > 0 & full$Age > 18 & full$Title != 'Miss'] <- 'Mother'\n\n# Show counts\ntable(full$Mother, full$Survived)\n\n# Finish by factorizing our two new factor variables\nfull$Child  <- factor(full$Child)\nfull$Mother <- factor(full$Mother)\n\nmd.pattern(full)", "cell_type": "code", "metadata": {"_cell_guid": "486ece12-1348-42d1-a5e4-9081ce1c736a", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "a6b3829d4e8f11190324f5957eb2887e377e343f"}}, {"execution_count": null, "outputs": [], "source": "## Step 3 \u2013 training a model on the data", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "7004ac66-c887-446b-9bad-d70be04f7f3c", "collapsed": false, "_uuid": "ef062d8e70f1a62f2336f9edddb37638588e151d"}}, {"execution_count": null, "outputs": [], "source": "# Split the data back into a train set and a test set\ntrain <- full[1:891,]\ntest <- full[892:1309,]\n\n# Set a random seed\nset.seed(754)\n\n# Build the model (note: not all possible variables are used)\n# Accuracy: 0.80861\n# rf_model <- randomForest(factor(Survived) ~ Pclass + Sex + Age + SibSp + Parch + \n#                                            Fare + Embarked + Title +\n#                                            FsizeD + Child + Mother +\n#                                            Deck,\n#                                            data = train)\n\n# Reduce variables further to avoid overfitting\nrf_model <- randomForest(factor(Survived) ~ Pclass + Sex + Fare +  \n                                            Embarked + Title + FsizeD + Child,\n                                            data = train)\n\nPclass + Sex + Fare + Embarked + Title + \n                           FsizeD + Child", "cell_type": "code", "metadata": {"_cell_guid": "07ca0d3c-b239-4c29-8a78-f4a7a021428d", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "b17b8beb34059b04f14b7c035191c7c1e3405d88"}}, {"execution_count": null, "outputs": [], "source": "# Get importance from random forest model\nimportance    <- importance(rf_model)\nvarImportance <- data.frame(Variables = row.names(importance), \n                            Importance = round(importance[ ,'MeanDecreaseGini'],2))\n\n# Create a rank variable based on importance\nrankImportance <- varImportance %>%\n  mutate(Rank = paste0('#',dense_rank(desc(Importance))))\n\n# Use ggplot2 to visualize the relative importance of variables\nggplot(rankImportance, aes(x = reorder(Variables, Importance), \n    y = Importance, fill = Importance)) +\n  geom_bar(stat='identity') + \n  geom_text(aes(x = Variables, y = 0.5, label = Rank),\n    hjust=0, vjust=0.55, size = 4, colour = 'red') +\n  labs(x = 'Variables') +\n  coord_flip() + \n  theme_few()", "cell_type": "code", "metadata": {"_cell_guid": "88a47c8e-82f2-4e87-a342-be84dce64971", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "46a9d6880712668c529e00a4febbff3dd3343408"}}, {"execution_count": null, "outputs": [], "source": "## Step 4 \u2013 evaluating model performance", "cell_type": "markdown", "metadata": {"_execution_state": "idle", "_cell_guid": "0261456c-1dc2-480e-bfd2-df3c6453f809", "collapsed": false, "_uuid": "ea22612b0c0c78b05cc0dc33b57e165d2e1abb52"}}, {"execution_count": null, "outputs": [], "source": "# Predict using the test set\nrf_prediction <- predict(rf_model, test)\n\n# Save the solution to a dataframe with two columns: PassengerId and Survived (prediction)\nrf_solution <- data.frame(PassengerID = test$PassengerId, Survived = rf_prediction)\n\n# Write the solution to file\nwrite.csv(rf_solution, file = 'Titanic_rf_Solution.csv', row.names = F)", "cell_type": "code", "metadata": {"_cell_guid": "bab52106-3548-49da-86f8-88c8bffbf37d", "_execution_state": "idle", "trusted": false, "collapsed": false, "_uuid": "49c70ecd1cd99687ab83a8ddbeb8cd9bd741c1f5"}}], "metadata": {"kernelspec": {"name": "ir", "display_name": "R", "language": "R"}, "language_info": {"mimetype": "text/x-r-source", "name": "R", "file_extension": ".r", "codemirror_mode": "r", "version": "3.4.0", "pygments_lexer": "r"}}, "nbformat": 4, "nbformat_minor": 0}